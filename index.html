<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語帳アプリ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f7; }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; }
        h1 { text-align: center; margin-bottom: 30px; color: #000; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: #007AFF; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .wordbook-item { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; cursor: pointer; }
        .quiz-card { background: white; padding: 30px; border-radius: 8px; text-align: center; margin: 20px 0; }
        .quiz-question { font-size: 18px; margin-bottom: 20px; }
        .quiz-answer { font-size: 16px; color: #666; }
        .hidden { display: none; }
        .user-info { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ログイン画面 -->
        <div id="login-screen" class="screen active">
            <h1>単語帳アプリ</h1>
            <button onclick="loginWithGoogle()">Googleでログイン</button>
            <input type="email" id="email" placeholder="メールアドレス">
            <input type="password" id="password" placeholder="パスワード">
            <button onclick="loginWithEmail()">メールでログイン</button>
            <button onclick="signupWithEmail()">新規登録</button>
        </div>

        <!-- ホーム画面 -->
        <div id="home-screen" class="screen">
            <div class="user-info">
                <span id="user-name"></span>
                <button onclick="logout()" style="width: auto; margin-left: 10px;">ログアウト</button>
            </div>
            <h1>ホーム</h1>
            <div id="recent-wordbook"></div>
            <button onclick="showScreen('create-screen')">新しい単語帳を作成</button>
            <button onclick="showScreen('wordbook-list-screen')">単語帳一覧</button>
        </div>

        <!-- 単語帳作成画面 -->
        <div id="create-screen" class="screen">
            <h1>単語帳作成</h1>
            <input type="text" id="keyword1" placeholder="キーワード1">
            <input type="text" id="keyword2" placeholder="キーワード2">
            <input type="text" id="keyword3" placeholder="キーワード3">
            <button onclick="createWordbook()">問題を生成</button>
            <button onclick="showScreen('home-screen')">戻る</button>
            <div id="loading" class="hidden">問題を生成中...</div>
        </div>

        <!-- 単語帳一覧画面 -->
        <div id="wordbook-list-screen" class="screen">
            <h1>単語帳一覧</h1>
            <div id="wordbook-list"></div>
            <button onclick="showScreen('home-screen')">戻る</button>
        </div>

        <!-- 学習画面 -->
        <div id="study-screen" class="screen">
            <h1 id="study-title"></h1>
            <div class="quiz-card">
                <div class="quiz-question" id="question"></div>
                <div class="quiz-answer hidden" id="answer"></div>
                <button id="show-answer" onclick="showAnswer()">答えを表示</button>
                <button id="next-question" onclick="nextQuestion()" class="hidden">次の問題</button>
            </div>
            <div>問題 <span id="current-q">1</span> / <span id="total-q">5</span></div>
            <button onclick="showScreen('home-screen')">ホームに戻る</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase設定
        const firebaseConfig = {
          apiKey: "AIzaSyBIN7HyNUw8xqfcuk2g2CDTJhRC1PD-STU",
          authDomain: "trifla.firebaseapp.com",
          projectId: "trifla",
          storageBucket: "trifla.firebasestorage.app",
          messagingSenderId: "432195541688",
          appId: "1:432195541688:web:771538a2a672218b75b24d",
          measurementId: "G-6CDYW1YWX1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // グローバル変数
        let currentUser = null;
        let wordbooks = [];
        let currentWordbook = null;
        let currentQuestionIndex = 0;

        // 認証状態監視
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-name').textContent = user.displayName || user.email;
                loadWordbooks();
                showScreen('home-screen');
            } else {
                currentUser = null;
                showScreen('login-screen');
            }
        });

        // ログイン関数
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert('ログインに失敗しました');
            }
        };

        window.loginWithEmail = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('ログインに失敗しました');
            }
        };

        window.signupWithEmail = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('登録に失敗しました');
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                alert('ログアウトに失敗しました');
            }
        };

        // 画面切り替え
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        };

        // 単語帳作成
        window.createWordbook = async () => {
            const k1 = document.getElementById('keyword1').value;
            const k2 = document.getElementById('keyword2').value;
            const k3 = document.getElementById('keyword3').value;
            
            if (!k1 || !k2 || !k3) {
                alert('すべてのキーワードを入力してください');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const questions = await generateQuestions([k1, k2, k3]);
                await saveWordbook(questions, `${k1}-${k2}-${k3}`);
                document.getElementById('keyword1').value = '';
                document.getElementById('keyword2').value = '';
                document.getElementById('keyword3').value = '';
                document.getElementById('loading').classList.add('hidden');
                loadWordbooks();
                showScreen('home-screen');
                alert('単語帳を作成しました');
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                alert('問題生成に失敗しました');
            }
        };

        // 問題生成（Gemini API）
        async function generateQuestions(keywords) {
            const patterns = [
                { q: [0, 1], a: [2] },
                { q: [0, 2], a: [1] },
                { q: [1, 2], a: [0] },
                { q: [0], a: [1, 2] },
                { q: [1], a: [0, 2] }
            ];
            
            const questions = [];
            
            for (let i = 0; i < patterns.length; i++) {
                const pattern = patterns[i];
                const qKeys = pattern.q.map(idx => keywords[idx]);
                const aKeys = pattern.a.map(idx => keywords[idx]);
                
                const prompt = `以下のキーワードから1つの問題を作成してください。
問題キーワード: ${qKeys.join(', ')}
答えキーワード: ${aKeys.join(', ')}
形式: 問題文を簡潔に作成し、答えは提供されたキーワードを使用してください。`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyAKFFyvFF_wlr86Jzi93hc91U4_my446Ys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                
                // 簡単な問題と答えの分離
                const lines = generatedText.split('\n').filter(line => line.trim());
                const question = lines[0] || `${qKeys.join(', ')}について説明してください`;
                const answer = aKeys.join(', ');
                
                questions.push({ question, answer });
            }
            
            return questions;
        }

        // 単語帳保存
        async function saveWordbook(questions, title) {
            const wordbook = {
                title,
                questions,
                createdAt: new Date(),
                userId: currentUser.uid
            };
            
            await addDoc(collection(db, 'wordbooks'), wordbook);
        }

        // 単語帳読み込み
        async function loadWordbooks() {
            const querySnapshot = await getDocs(collection(db, 'wordbooks'));
            wordbooks = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.userId === currentUser.uid) {
                    wordbooks.push({ id: doc.id, ...data });
                }
            });
            
            // 最新の単語帳をホームに表示
            if (wordbooks.length > 0) {
                const latest = wordbooks.sort((a, b) => b.createdAt - a.createdAt)[0];
                document.getElementById('recent-wordbook').innerHTML = `
                    <div class="wordbook-item" onclick="startStudy('${latest.id}')">
                        <strong>最近の学習:</strong> ${latest.title}
                    </div>
                `;
            }
            
            // 単語帳一覧を表示
            const listHtml = wordbooks.map(wb => `
                <div class="wordbook-item" onclick="startStudy('${wb.id}')">
                    ${wb.title}
                </div>
            `).join('');
            document.getElementById('wordbook-list').innerHTML = listHtml;
        }

        // 学習開始
        window.startStudy = (wordbookId) => {
            currentWordbook = wordbooks.find(wb => wb.id === wordbookId);
            currentQuestionIndex = 0;
            document.getElementById('study-title').textContent = currentWordbook.title;
            document.getElementById('total-q').textContent = currentWordbook.questions.length;
            showQuestion();
            showScreen('study-screen');
        };

        // 問題表示
        function showQuestion() {
            const q = currentWordbook.questions[currentQuestionIndex];
            document.getElementById('question').textContent = q.question;
            document.getElementById('answer').textContent = q.answer;
            document.getElementById('current-q').textContent = currentQuestionIndex + 1;
            document.getElementById('answer').classList.add('hidden');
            document.getElementById('show-answer').classList.remove('hidden');
            document.getElementById('next-question').classList.add('hidden');
        }

        // 答え表示
        window.showAnswer = () => {
            document.getElementById('answer').classList.remove('hidden');
            document.getElementById('show-answer').classList.add('hidden');
            document.getElementById('next-question').classList.remove('hidden');
        };

        // 次の問題
        window.nextQuestion = () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentWordbook.questions.length) {
                showQuestion();
            } else {
                alert('学習完了！');
                showScreen('home-screen');
            }
        };

        // PWA対応
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
